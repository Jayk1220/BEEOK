@customer_bp.route('/<customer_id>/add-memo', methods=['POST'])
def add_memo(customer_id):
    memo_text = request.form.get('memo_text')
    conn = db.engine.raw_connection()
    cursor = conn.cursor()
    
    try:
        # 1. 메모 이력 추가 (서브쿼리로 MEMO_NO 자동 생성)
        sql = """
            INSERT INTO CUSTOMER_MEMO (CUSTOMER_ID, MEMO_NO, MEMO_TEXT, DATE)
            VALUES (%s, (SELECT IFNULL(MAX(MEMO_NO), 0) + 1 FROM CUSTOMER_MEMO WHERE CUSTOMER_ID = %s), %s, NOW())
        """
        cursor.execute(sql, (customer_id, customer_id, memo_text))
        
        # 2. (선택) 여기서 AI 요약 로직을 호출하여 CUSTOMER.MEMO를 업데이트할 수 있습니다.
        
        conn.commit()
        flash("상담 기록이 추가되었습니다.")
    except Exception as e:
        conn.rollback()
        flash(f"저장 실패: {str(e)}")
    finally:
        cursor.close()
        conn.close()
        
    return redirect(url_for('customer.customer_info', customer_id=customer_id))