{% extends "layout.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/4.customer/customer_registration.css') }}">

<div class="reg-wrapper">
    <div class="page-header">
        <h2><i class="bi bi-person-lines-fill me-2"></i>고객 정보 및 상담 이력</h2>
        <a href="{{ url_for('customer.list_customer') }}" class="btn-back-link">
            <i class="bi bi-arrow-left"></i> 목록으로 돌아가기
        </a>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert-banner">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <section class="form-section">
        <div class="form-grid info-timeline-layout">
            
            <div class="info-side">
                <form action="{{ url_for('customer.customer_info', customer_id=customer.CUSTOMER_ID) }}" method="POST">
                    <div class="form-card">
                        <h3 class="card-title">기본 정보 수정</h3>
                        
                        <div class="input-group">
                            <label>고객 ID (수정 불가)</label>
                            <input type="text" value="{{ customer.CUSTOMER_ID }}" readonly class="readonly-input">
                        </div>

                        <div class="input-group">
                            <label>상호명 (기업명)</label>
                            <input type="text" name="company_name" value="{{ customer.COMPANY_NAME or '' }}">
                        </div>

                        <div class="input-group-row">
                            <div class="input-group">
                                <label>담당자 성함 <span class="required">*</span></label>
                                <input type="text" name="contact_person" value="{{ customer.CONTACT_PERSON }}" required>
                            </div>
                            <div class="input-group">
                                <label>현재 상태</label>
                                <select name="status">
                                    {% for s in status_list %}
                                    <option value="{{ s }}" {% if s == customer.STATUS %}selected{% endif %}>{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>연락처 <span class="required">*</span></label>
                            <input type="text" name="contact" value="{{ customer.CONTACT }}" required>
                        </div>

                        <div class="input-group">
                            <label>상세 주소</label>
                            <textarea name="address" rows="3">{{ customer.ADDRESS or '' }}</textarea>
                        </div>
                    </div>

                    <div class="form-actions info-actions">
                        <button type="submit" class="btn-submit">수정 내용 저장</button>
                    </div>
                </form>
            </div>

            <div class="memo-side">
                
                <div class="ai-summary-card">
                    <h3 class="card-title no-border">
                        <i class="bi bi-robot me-2"></i> AI 상담 요약
                    </h3>
                    <div class="ai-content">
                        {{ customer.MEMO if customer.MEMO else "아직 요약된 상담 내용이 없습니다." }}
                    </div>
                    <div class="ai-footer">
                        최종 업데이트: {{ customer.SUMMARY_TIME if customer.SUMMARY_TIME else '기록 없음' }}
                    </div>
                </div>

                <div class="timeline-section">
                    <div class="timeline-header">
                        <h3 class="card-title no-border">상담 이력</h3>
                        <button class="btn-add-memo" data-bs-toggle="modal" data-bs-target="#memoModal">
                            <i class="bi bi-plus-lg"></i> 기록 추가
                        </button>
                    </div>

                    <div class="timeline-list">
                        {% for memo in memos %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-card">
                                <div class="timeline-meta">
                                    <span class="t-date">{{ memo.DATE.strftime('%Y-%m-%d %H:%M') }}</span>
                                    <span class="t-id">ID: {{ memo.SYS_ID }}</span>
                                </div>
                                <div class="timeline-body">{{ memo.MEMO_TEXT }}</div>
                            </div>
                        </div>
                        {% else %}
                        <div class="empty-memo">등록된 상담 기록이 없습니다.</div>
                        {% endfor %}
                    </div>
                </div>
                
            </div> </div> </section>
</div>

{% endblock %}