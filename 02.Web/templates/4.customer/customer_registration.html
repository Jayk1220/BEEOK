{% extends "layout.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/4.customer/customer_registration.css') }}">
<style>
    .info-memo-grid { grid-template-columns: 1fr 1.2fr; gap: 40px; }
    .ai-summary-box { background: #f0f7ff; border: 1px dashed #007bff; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
    .timeline-container { max-height: 600px; overflow-y: auto; padding-right: 15px; }
    .timeline-item { border-left: 2px solid #e9ecef; padding-left: 20px; position: relative; margin-bottom: 20px; }
    .timeline-item::before { content: ''; position: absolute; left: -7px; top: 5px; width: 12px; height: 12px; background: #4dabf7; border-radius: 50%; }
    .timeline-date { font-size: 0.8rem; font-weight: 700; color: #adb5bd; }
    .timeline-text { background: white; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px; margin-top: 5px; font-size: 0.95rem; }
</style>

<div class="reg-wrapper">
    <div class="page-header">
        <h2><i class="bi bi-person-lines-fill me-2"></i>고객 상세 정보 및 상담 이력</h2>
        <a href="{{ url_for('customer.list_customer') }}" class="btn-back">
            <i class="bi bi-arrow-left"></i> 목록으로 돌아가기
        </a>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert-banner">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <section class="form-section">
        <div class="form-grid info-memo-grid">
            
            <div class="info-side">
                <form action="#" method="POST">
                    <div class="form-card card-main">
                        <h3 class="card-title">기본 정보 수정</h3>
                        
                        <div class="input-group">
                            <label>고객 ID (수정 불가)</label>
                            <input type="text" value="{{ customer.CUSTOMER_ID }}" readonly style="background-color: #f8f9fa; color: #6c757d;">
                        </div>

                        <div class="input-group">
                            <label>상호명 (기업명)</label>
                            <input type="text" name="company_name" value="{{ customer.COMPANY_NAME or '' }}">
                        </div>

                        <div class="input-group-row">
                            <div class="input-group">
                                <label>담당자 성함 <span class="required">*</span></label>
                                <input type="text" name="contact_person" value="{{ customer.CONTACT_PERSON }}" required>
                            </div>
                            <div class="input-group">
                                <label>상태</label>
                                <select name="status">
                                    {% for s in status_list %}
                                    <option value="{{ s }}" {% if s == customer.STATUS %}selected{% endif %}>{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>연락처 <span class="required">*</span></label>
                            <input type="text" name="contact" value="{{ customer.CONTACT }}" required>
                        </div>

                        <div class="input-group">
                            <label>이메일</label>
                            <input type="email" name="email" value="{{ customer.EMAIL or '' }}">
                        </div>

                        <div class="input-group">
                            <label>상세 주소</label>
                            <textarea name="address" rows="2">{{ customer.ADDRESS or '' }}</textarea>
                        </div>
                    </div>

                    <div class="form-actions" style="background: none; padding: 20px 0 0 0;">
                        <button type="submit" class="btn-submit" style="width: 100%;">수정 내용 저장하기</button>
                    </div>
                </form>
            </div>

            <div class="memo-side">
                <div class="ai-summary-box">
                    <h3 class="card-title" style="border: none; margin-bottom: 10px;">
                        <i class="bi bi-robot me-2"></i> AI 상담 요약
                    </h3>
                    <p style="margin: 0; color: #495057; line-height: 1.6;">
                        {{ customer.MEMO if customer.MEMO else "데이터가 충분하지 않아 요약된 내용이 없습니다." }}
                    </p>
                    <div style="text-align: right; font-size: 0.75rem; color: #adb5bd; margin-top: 10px;">
                        최종 업데이트: {{ customer.SUMMARY_TIME if customer.SUMMARY_TIME else '기록 없음' }}
                    </div>
                </div>

                <div class="form-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="card-title" style="margin-bottom: 0;">상담 이력</h3>
                        <button class="btn-reset" style="padding: 5px 15px; font-size: 0.8rem;" data-bs-toggle="modal" data-bs-target="#memoModal">
                            + 새 상담 추가
                        </button>
                    </div>

                    <div class="timeline-container">
                        {% for memo in memos %}
                        <div class="timeline-item">
                            <div class="timeline-date">{{ memo.DATE.strftime('%Y-%m-%d %H:%M') }}</div>
                            <div class="timeline-text">{{ memo.MEMO_TEXT }}</div>
                            <div style="font-size: 0.7rem; color: #dee2e6; text-align: right;">작성자: {{ memo.SYS_ID }}</div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-5">등록된 상담 기록이 없습니다.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<div class="modal fade" id="memoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('customer.add_memo', customer_id=customer.CUSTOMER_ID) }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">상담 기록 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea name="memo_text" class="form-control" rows="5" placeholder="상담 내용을 입력하세요..." required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-reset" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn-submit">기록 저장</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}